#!/bin/bash

# FinOps Aggregator Development Environment Startup Script
# This script starts all necessary services for local development:
# - PostgreSQL database
# - Backend API server (Go)
# - Frontend development server (Next.js)

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
BACKEND_DIR="$PROJECT_ROOT/backend"
FRONTEND_DIR="$PROJECT_ROOT/frontend"

# Database configuration
DB_CONTAINER_NAME="finops-postgres"
DB_NAME="finops"
DB_USER="finops"
DB_PASSWORD="finops"
DB_PORT="5432"

# API configuration
API_PORT="8080"

# Process tracking
BACKEND_PID=""
FRONTEND_PID=""

# Function to print colored messages
print_info() {
    echo -e "${BLUE}ℹ ${NC}$1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_header() {
    echo ""
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""
}

# Function to check if Docker is installed and running
check_docker() {
    if ! command -v docker &> /dev/null; then
        print_error "Docker is not installed. Please install Docker first."
        exit 1
    fi
    
    if ! docker info &> /dev/null; then
        print_error "Docker is not running. Please start Docker first."
        exit 1
    fi
    
    print_success "Docker is available"
}

# Function to check if Go is installed
check_go() {
    if ! command -v go &> /dev/null; then
        print_error "Go is not installed. Please install Go 1.22 or later."
        exit 1
    fi
    
    GO_VERSION=$(go version | awk '{print $3}' | sed 's/go//')
    print_success "Go $GO_VERSION is installed"
}

# Function to check if Node.js is installed
check_node() {
    if ! command -v node &> /dev/null; then
        print_error "Node.js is not installed. Please install Node.js 18 or later."
        exit 1
    fi
    
    if ! command -v npm &> /dev/null; then
        print_error "npm is not installed. Please install npm."
        exit 1
    fi
    
    NODE_VERSION=$(node --version)
    NPM_VERSION=$(npm --version)
    print_success "Node.js $NODE_VERSION and npm $NPM_VERSION are installed"
}

# Function to check if database container exists
container_exists() {
    docker ps -a --format '{{.Names}}' | grep -q "^${DB_CONTAINER_NAME}$"
}

# Function to check if database container is running
container_running() {
    docker ps --format '{{.Names}}' | grep -q "^${DB_CONTAINER_NAME}$"
}

# Function to start the database
start_database() {
    print_header "Starting PostgreSQL Database"
    
    if container_exists; then
        if container_running; then
            print_success "Database container is already running"
        else
            print_info "Starting existing database container..."
            docker start ${DB_CONTAINER_NAME}
            print_success "Database container started"
        fi
    else
        print_info "Creating new database container..."
        docker run -d \
            --name ${DB_CONTAINER_NAME} \
            -e POSTGRES_DB=${DB_NAME} \
            -e POSTGRES_USER=${DB_USER} \
            -e POSTGRES_PASSWORD=${DB_PASSWORD} \
            -p ${DB_PORT}:5432 \
            postgres:15-alpine
        
        print_success "Database container created and started"
        print_info "Waiting for database to be ready..."
        sleep 3
    fi
    
    # Wait for database to be ready
    print_info "Checking database connectivity..."
    for i in {1..30}; do
        if docker exec ${DB_CONTAINER_NAME} pg_isready -U ${DB_USER} -d ${DB_NAME} &>/dev/null; then
            print_success "Database is ready"
            break
        fi
        if [ $i -eq 30 ]; then
            print_error "Database failed to start within 30 seconds"
            exit 1
        fi
        sleep 1
    done
    
    echo ""
    print_info "Database connection: postgresql://${DB_USER}:${DB_PASSWORD}@localhost:${DB_PORT}/${DB_NAME}"
}

# Function to run database migrations
run_migrations() {
    print_header "Running Database Migrations"
    
    cd "$BACKEND_DIR"
    
    if command -v migrate &> /dev/null; then
        print_info "Running migrations..."
        migrate -path migrations -database "postgresql://${DB_USER}:${DB_PASSWORD}@localhost:${DB_PORT}/${DB_NAME}?sslmode=disable" up
        print_success "Migrations completed"
    else
        print_warning "migrate tool not found, trying make migrate-up..."
        if make migrate-up 2>/dev/null; then
            print_success "Migrations completed via make"
        else
            print_warning "Could not run migrations automatically"
            print_info "You may need to run: cd backend && make migrate-up"
        fi
    fi
}

# Function to check and load demo data
check_demo_data() {
    print_header "Checking Demo Data"
    
    cd "$BACKEND_DIR"
    
    # Check if demo data exists
    DEMO_COUNT=$(docker exec ${DB_CONTAINER_NAME} psql -U ${DB_USER} -d ${DB_NAME} -t -c "SELECT COUNT(*) FROM cost_nodes;" 2>/dev/null | tr -d ' ' || echo "0")
    
    if [ "$DEMO_COUNT" -eq "0" ]; then
        print_warning "No data found in database"
        read -p "Would you like to load demo data? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            print_info "Loading demo data..."
            if [ -f "bin/finops" ]; then
                ./bin/finops demo seed
            else
                print_info "Building backend first..."
                make build
                ./bin/finops demo seed
            fi
            print_success "Demo data loaded"
        fi
    else
        print_success "Database contains $DEMO_COUNT cost nodes"
    fi
}

# Function to start the backend API server
start_backend() {
    print_header "Starting Backend API Server"
    
    cd "$BACKEND_DIR"
    
    # Build the backend if needed
    if [ ! -f "bin/finops" ]; then
        print_info "Building backend..."
        make build
        print_success "Backend built successfully"
    fi
    
    # Create config file if it doesn't exist
    if [ ! -f "config.yaml" ]; then
        print_info "Creating config.yaml from example..."
        cp config.yaml.example config.yaml
        print_success "Config file created"
    fi
    
    print_info "Starting API server on port ${API_PORT}..."
    print_info "API will be available at: http://localhost:${API_PORT}"
    
    # Start the API server in the background
    go run ./cmd/finops api &
    BACKEND_PID=$!
    
    # Wait a moment for the server to start
    sleep 2
    
    # Check if the process is still running
    if kill -0 $BACKEND_PID 2>/dev/null; then
        print_success "Backend API server started (PID: $BACKEND_PID)"
    else
        print_error "Backend API server failed to start"
        exit 1
    fi
}

# Function to start the frontend development server
start_frontend() {
    print_header "Starting Frontend Development Server"
    
    cd "$FRONTEND_DIR"
    
    # Install dependencies if node_modules doesn't exist
    if [ ! -d "node_modules" ]; then
        print_info "Installing frontend dependencies..."
        npm install
        print_success "Dependencies installed"
    fi
    
    print_info "Starting Next.js development server..."
    print_info "Frontend will be available at: http://localhost:3000"
    
    # Start the frontend server in the background
    npm run dev &
    FRONTEND_PID=$!
    
    # Wait a moment for the server to start
    sleep 2
    
    # Check if the process is still running
    if kill -0 $FRONTEND_PID 2>/dev/null; then
        print_success "Frontend development server started (PID: $FRONTEND_PID)"
    else
        print_error "Frontend development server failed to start"
        exit 1
    fi
}

# Function to cleanup on exit
cleanup() {
    echo ""
    print_header "Shutting Down Development Environment"
    
    if [ -n "$FRONTEND_PID" ] && kill -0 $FRONTEND_PID 2>/dev/null; then
        print_info "Stopping frontend server (PID: $FRONTEND_PID)..."
        kill $FRONTEND_PID 2>/dev/null || true
        wait $FRONTEND_PID 2>/dev/null || true
        print_success "Frontend server stopped"
    fi
    
    if [ -n "$BACKEND_PID" ] && kill -0 $BACKEND_PID 2>/dev/null; then
        print_info "Stopping backend server (PID: $BACKEND_PID)..."
        kill $BACKEND_PID 2>/dev/null || true
        wait $BACKEND_PID 2>/dev/null || true
        print_success "Backend server stopped"
    fi
    
    print_info "Database container is still running"
    print_info "To stop it: docker stop ${DB_CONTAINER_NAME}"
    print_info "To remove it: docker rm ${DB_CONTAINER_NAME}"
    
    echo ""
    print_success "Development environment shut down"
    exit 0
}

# Trap Ctrl+C and other termination signals
trap cleanup INT TERM

# Main execution
main() {
    print_header "FinOps Aggregator Development Environment"
    
    print_info "Checking prerequisites..."
    check_docker
    check_go
    check_node
    
    start_database
    run_migrations
    check_demo_data
    start_backend
    start_frontend
    
    print_header "Development Environment Ready!"
    echo ""
    print_success "All services are running:"
    echo ""
    echo -e "  ${BLUE}Frontend:${NC}  http://localhost:3000"
    echo -e "  ${BLUE}Backend:${NC}   http://localhost:${API_PORT}"
    echo -e "  ${BLUE}Database:${NC}  postgresql://${DB_USER}:${DB_PASSWORD}@localhost:${DB_PORT}/${DB_NAME}"
    echo ""
    print_info "Press Ctrl+C to stop all services"
    echo ""
    
    # Wait for user to press Ctrl+C
    wait
}

# Run main function
main

